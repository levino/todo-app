---
import Layout from '@levino/shipyard-base/layouts/Page.astro'
import { getPocketBase } from '@/lib/pocketbase'

interface Child {
  id: string
  name: string
  avatar: string
  group: string
}

interface KioskTask {
  id: string
  title: string
  child: string
  priority: number | null
  completed: boolean
  completedAt: string | null
}

const { childId } = Astro.params

let child: Child | null = null
let siblings: Child[] = []
let tasks: KioskTask[] = []
let error = ''

try {
  const pb = getPocketBase()

  // Fetch the child
  child = await pb.collection('children').getOne<Child>(childId!)

  // Fetch all siblings (children in the same group)
  const siblingsResult = await pb.collection('children').getList<Child>(1, 100, {
    filter: `group = "${child.group}"`,
    sort: 'name',
  })
  siblings = siblingsResult.items

  // Fetch incomplete tasks for this child, sorted by priority
  const result = await pb.collection('kiosk_tasks').getList<KioskTask>(1, 100, {
    filter: `child = "${childId}" && completed = false`,
    sort: 'priority,-created',
  })
  tasks = result.items
} catch (e) {
  error = 'Fehler beim Laden der Aufgaben.'
}

const showSwitcher = siblings.length > 1
---

<Layout title={child ? `${child.name} - Aufgaben` : 'Kiosk'}>
  <div class="min-h-screen bg-base-100 p-4 md:p-8">
    {error && (
      <div class="alert alert-error mb-6">
        <span>{error}</span>
      </div>
    )}

    {child && (
      <div class="max-w-3xl mx-auto">
        {/* Child switcher - only show if multiple children */}
        {showSwitcher && (
          <nav data-testid="child-switcher" class="flex gap-2 mb-6 overflow-x-auto pb-2">
            {siblings.map((sibling) => (
              <a
                href={`/kiosk/${sibling.id}`}
                data-testid="child-tab"
                class:list={[
                  'flex items-center gap-2 px-4 py-3 rounded-xl min-h-[56px] min-w-[120px] transition-colors',
                  sibling.id === childId
                    ? 'bg-primary text-primary-content font-bold'
                    : 'bg-base-200 hover:bg-base-300',
                ]}
              >
                {sibling.avatar && (
                  <span class="text-2xl">{sibling.avatar}</span>
                )}
                <span class="text-lg">{sibling.name}</span>
              </a>
            ))}
          </nav>
        )}

        {/* Child header */}
        <header class="flex items-center gap-4 mb-8">
          {child.avatar && (
            <span class="text-5xl">{child.avatar}</span>
          )}
          <h1 class="text-3xl md:text-4xl font-bold">{child.name}</h1>
        </header>

        {/* Task list or celebration */}
        {tasks.length === 0 ? (
          <div data-testid="celebration" class="text-center py-16">
            <div data-testid="celebration-emoji" class="text-8xl mb-6">ðŸŒŸ</div>
            <h2 class="text-3xl md:text-4xl font-bold text-success mb-4">Super gemacht!</h2>
            <p class="text-xl md:text-2xl text-base-content/70">
              Alle Aufgaben erledigt!
            </p>
          </div>
        ) : (
          <ul class="space-y-3">
            {tasks.map((task) => (
              <li
                data-testid="task-item"
                class="flex items-center gap-4 p-4 bg-base-200 rounded-xl min-h-[56px]"
              >
                <form method="POST" action={`/kiosk/task/${task.id}/complete`}>
                  <input type="hidden" name="childId" value={childId} />
                  <button
                    type="submit"
                    data-testid="complete-button"
                    class="btn btn-circle btn-lg btn-outline btn-success min-w-[56px] min-h-[56px]"
                    aria-label={`${task.title} erledigen`}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                  </button>
                </form>
                <span class="text-xl md:text-2xl flex-1">{task.title}</span>
              </li>
            ))}
          </ul>
        )}
      </div>
    )}

    {!child && !error && (
      <div class="text-center py-16">
        <p class="text-2xl text-gray-500">Kind nicht gefunden.</p>
      </div>
    )}
  </div>
</Layout>
