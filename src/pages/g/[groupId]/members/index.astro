---
import Layout from '@levino/shipyard-base/layouts/Page.astro'
import ColoredInitials from '@/components/ColoredInitials.astro'

interface User {
  id: string
  email: string
}

interface Child {
  id: string
  name: string
  color: string
}

interface UserGroup {
  id: string
  user: string
  expand?: {
    user?: User
  }
}

const { pb, user, groupId } = Astro.locals

if (!user || !groupId) {
  return Astro.redirect('/login')
}

// Get group info
let groupName = ''
try {
  const group = await pb.collection('groups').getOne(groupId)
  groupName = group.name
} catch {
  return Astro.redirect('/settings/groups')
}

// Get members (users with login)
let members: User[] = []
let children: Child[] = []
let error = ''

const urlError = Astro.url.searchParams.get('error')
const success = Astro.url.searchParams.get('success')

try {
  // Get users in this group
  const userGroupsResult = await pb.collection('user_groups').getList<UserGroup>(1, 100, {
    filter: `group = "${groupId}"`,
    expand: 'user',
  })
  members = userGroupsResult.items
    .map((ug) => ug.expand?.user)
    .filter((u): u is User => u !== undefined)

  // Get children in this group
  const childrenResult = await pb.collection('children').getList<Child>(1, 100, {
    filter: `group = "${groupId}"`,
    sort: 'name',
  })
  children = childrenResult.items
} catch (e) {
  console.error('Failed to load members:', e)
  error = 'Fehler beim Laden der Mitglieder'
}
---

<Layout title={`Mitglieder - ${groupName}`}>
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="flex items-center gap-4 mb-8">
      <a href={`/g/${groupId}/tasks`} class="btn btn-ghost btn-sm">
        ← Zurück
      </a>
      <h1 class="text-3xl font-bold">Mitglieder</h1>
    </div>

    <p class="text-base-content/70 mb-6">{groupName}</p>

    {error && (
      <div class="alert alert-error mb-6">
        <span>{error}</span>
      </div>
    )}

    {urlError && (
      <div class="alert alert-error mb-6">
        <span>{decodeURIComponent(urlError)}</span>
      </div>
    )}

    {success && (
      <div class="alert alert-success mb-6">
        <span>{decodeURIComponent(success)}</span>
      </div>
    )}

    {/* Add user form */}
    <div class="card bg-base-200 mb-8">
      <div class="card-body">
        <h2 class="card-title text-xl">Benutzer hinzufügen</h2>
        <form method="POST" action={`/api/groups/${groupId}/members/add`} class="flex gap-2">
          <input
            type="email"
            name="email"
            placeholder="E-Mail-Adresse"
            class="input input-bordered flex-1"
            required
          />
          <button type="submit" class="btn btn-primary">
            Hinzufügen
          </button>
        </form>
        <p class="text-sm text-base-content/50 mt-2">
          Der Benutzer muss bereits registriert sein.
        </p>
      </div>
    </div>

    {/* Users section */}
    <h2 class="text-xl font-bold mb-4">Benutzer ({members.length})</h2>
    <ul class="space-y-3 mb-8">
      {members.map((member) => (
        <li class="flex items-center justify-between p-4 bg-base-200 rounded-xl">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-base-300 flex items-center justify-center text-lg font-bold">
              {member.email.charAt(0).toUpperCase()}
            </div>
            <div>
              <span class="text-lg font-medium">{member.email}</span>
              {member.id === user.id && (
                <span class="ml-2 badge badge-primary">Du</span>
              )}
            </div>
          </div>
          <div class="flex gap-2">
            {member.id === user.id ? (
              <form method="POST" action={`/api/groups/${groupId}/leave`}>
                <button
                  type="submit"
                  class="btn btn-warning btn-outline btn-sm"
                  onclick="return confirm('Möchtest du diese Gruppe wirklich verlassen?')"
                >
                  Verlassen
                </button>
              </form>
            ) : (
              <form method="POST" action={`/api/groups/${groupId}/members/${member.id}/remove`}>
                <button
                  type="submit"
                  class="btn btn-error btn-outline btn-sm"
                  onclick="return confirm('Möchtest du diesen Benutzer wirklich entfernen?')"
                >
                  Entfernen
                </button>
              </form>
            )}
          </div>
        </li>
      ))}
    </ul>

    {/* Children section */}
    <h2 class="text-xl font-bold mb-4">Kinder ({children.length})</h2>
    {children.length === 0 ? (
      <div class="text-center py-8 bg-base-200 rounded-xl">
        <p class="text-base-content/70">Keine Kinder in dieser Gruppe.</p>
        <a href={`/g/${groupId}/children`} class="btn btn-primary btn-sm mt-4">
          Kinder verwalten
        </a>
      </div>
    ) : (
      <ul class="space-y-3">
        {children.map((child) => (
          <li class="flex items-center gap-4 p-4 bg-base-200 rounded-xl">
            <ColoredInitials name={child.name} color={child.color} size="md" />
            <span class="text-lg font-medium">{child.name}</span>
          </li>
        ))}
      </ul>
    )}
  </div>
</Layout>
