# E2E Tests (Playwright)
# Full stack with PocketBase and MCP services running
#
# Usage:
#   docker compose -f docker-compose.e2e.yaml up -d pocketbase mcp
#   docker compose -f docker-compose.e2e.yaml run --rm playwright yarn playwright test

services:
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:0.36.1
    environment:
      - PB_ADMIN_EMAIL=admin@test.local
      - PB_ADMIN_PASSWORD=testtest123
    volumes:
      - pb_data_e2e:/pb_data
      - ./packages/api/pocketbase/pb_migrations:/pb_migrations
    command: ["--migrationsDir=/pb_migrations"]
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8090/api/health"]
      interval: 5s
      timeout: 5s
      retries: 3

  mcp:
    image: node:22
    working_dir: /app
    ports:
      - "3002:3001"
    environment:
      - POCKETBASE_URL=http://pocketbase:8090
      - POCKETBASE_ADMIN_EMAIL=admin@test.local
      - POCKETBASE_ADMIN_PASSWORD=testtest123
      - OAUTH_ISSUER=http://localhost:3002
      - FRONTEND_URL=http://localhost:4322
    volumes:
      - ./packages/mcp:/app
      - mcp_node_modules_e2e:/app/node_modules
      - mcp_data_e2e:/app/data
    depends_on:
      pocketbase:
        condition: service_healthy
    command: sh -c "chown -R node:node /app/node_modules /app/data && su node -c 'npm install && npx tsx --watch src/server.ts'"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 5s
      timeout: 5s
      retries: 3

  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    user: "1000:1000"
    working_dir: /app
    environment:
      - POCKETBASE_URL=http://pocketbase:8090
      - MCP_URL=http://mcp:3001
    volumes:
      - .:/app
      - node_modules_e2e:/app/node_modules
    depends_on:
      pocketbase:
        condition: service_healthy
      mcp:
        condition: service_healthy

volumes:
  node_modules_e2e:
  pb_data_e2e:
  mcp_node_modules_e2e:
  mcp_data_e2e:
