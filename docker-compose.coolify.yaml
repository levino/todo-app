# Production Docker Compose for Coolify/Shipyard Deployment
#
# Services:
# - frontend: Astro SSR app (port 3000)
# - mcp: MCP server for Claude integration (port 3001)
# - pocketbase: Database and auth (port 8090)
#
# First-time setup:
# 1. Deploy with pocketbase service only
# 2. Open PocketBase admin URL (check logs for setup link)
# 3. Create admin user via the web UI
# 4. Set POCKETBASE_ADMIN_EMAIL and POCKETBASE_ADMIN_PASSWORD in Coolify
# 5. Deploy full stack
#
# Required environment variables (set in Coolify):
# - POCKETBASE_ADMIN_EMAIL: Admin email created in PocketBase UI
# - POCKETBASE_ADMIN_PASSWORD: Admin password created in PocketBase UI
#
# Optional:
# - OAUTH_RSA_PRIVATE_KEY: RSA private key in PEM format (auto-generated if not set)
# - DEBUG_MCP: Set to 'true' for verbose request/response logging

services:
  frontend:
    build:
      context: .
      dockerfile: packages/frontend/Dockerfile
    depends_on:
      pocketbase:
        condition: service_healthy
      mcp:
        condition: service_started
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - POCKETBASE_URL=http://pocketbase:8090
      - MCP_INTERNAL_URL=http://mcp:3001
      - PUBLIC_MCP_URL=${SERVICE_URL_MCP}
    expose:
      - "3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mcp:
    build:
      context: .
      dockerfile: packages/mcp/Dockerfile
    depends_on:
      pocketbase:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - POCKETBASE_URL=http://pocketbase:8090
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD}
      - OAUTH_ISSUER=${SERVICE_URL_MCP}
      - FRONTEND_URL=${SERVICE_URL_FRONTEND}
      - DEBUG_MCP=${DEBUG_MCP:-false}
    volumes:
      - mcp_data:/app/data
    expose:
      - "3001"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  pocketbase:
    build:
      context: ./packages/api/pocketbase
      dockerfile: Dockerfile
    volumes:
      - pb_data:/pb_data
    expose:
      - "8090"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  pb_data:
  mcp_data:
