---
import Layout from '@levino/shipyard-base/layouts/Page.astro'
import ColoredInitials from '@/components/ColoredInitials.astro'
import DevSchedulerButton from '@/components/DevSchedulerButton.astro'
import TaskSubscription from '@/components/TaskSubscription.astro'
import { getPublicPocketBaseUrl } from '@/lib/pocketbase'

interface Child {
  id: string
  name: string
  color: string
  group: string
}

interface Task {
  id: string
  title: string
  child: string
  priority: number | null
  completed: boolean
  completedAt: string | null
  schedule?: string
  generatedAt?: string | null
}


// Sort tasks by priority
function sortByPriority(tasks: Task[]): Task[] {
  return [...tasks].sort((a, b) => {
    const priorityA = (a.priority === null || a.priority === undefined || a.priority === 0) ? Infinity : a.priority
    const priorityB = (b.priority === null || b.priority === undefined || b.priority === 0) ? Infinity : b.priority
    return priorityA - priorityB
  })
}

const { groupId, childId } = Astro.params
const { pb, user, now: injectedNow } = Astro.locals as { pb: any; user: any; now?: Date }

if (!user || !groupId || !childId) {
  return Astro.redirect('/login')
}

let child: Child | null = null
let siblings: Child[] = []
let tasks: Task[] = []
let error = ''


try {
  // Fetch the child
  child = await pb.collection('children').getOne<Child>(childId)

  // Verify child belongs to this group
  if (child.group !== groupId) {
    return Astro.redirect(`/group/${groupId}/tasks`)
  }

  // Fetch all siblings (children in the same group)
  try {
    const siblingsResult = await pb.collection('children').getList<Child>(1, 100, {
      filter: `group = "${groupId}"`,
      sort: 'name',
    })
    siblings = siblingsResult.items
  } catch (siblingsError) {
    console.error('Siblings fetch error:', siblingsError)
  }

  // Fetch incomplete tasks for this child that are currently visible
  // Tasks with visibleFrom in the future are not shown yet
  try {
    const now = (injectedNow || new Date()).toISOString()
    // Fetch all incomplete tasks first, then filter by visibleFrom
    // PocketBase date comparison can be tricky, so we filter in JS for reliability
    const result = await pb.collection('tasks').getList<Task>(1, 100, {
      filter: `child = "${childId}" && completed = false`,
    })

    // Filter tasks that are currently visible (visibleFrom is empty or <= now)
    const visibleTasks = result.items.filter((task: Task & { visibleFrom?: string }) => {
      if (!task.visibleFrom) return true // No visibleFrom means immediately visible
      return new Date(task.visibleFrom) <= new Date(now)
    })

    // Sort tasks by priority
    tasks = sortByPriority(visibleTasks)

    // Tasks are now simply fetched and sorted by priority
  } catch (tasksError) {
    console.error('Tasks fetch error:', tasksError)
  }
} catch (e) {
  console.error('Child fetch error:', e)
  error = `Fehler beim Laden der Aufgaben. (${childId})`
}

const showSwitcher = siblings.length > 1
---

<Layout title={child ? `${child.name} - Aufgaben` : 'Aufgaben'}>
  <div class="min-h-screen bg-base-100 p-4 md:p-8">
    {error && (
      <div class="alert alert-error mb-6">
        <span>{error}</span>
      </div>
    )}

    {child && (
      <div class="max-w-3xl mx-auto">
        <TaskSubscription
          childId={childId}
          pocketbaseUrl={getPublicPocketBaseUrl()}
          authToken={pb.authStore.token}
        />
        {/* Child switcher - only show if multiple children */}
        {showSwitcher && (
          <nav data-testid="child-switcher" class="flex gap-2 mb-6 overflow-x-auto pb-2">
            {siblings.map((sibling) => (
              <a
                href={`/group/${groupId}/tasks/${sibling.id}`}
                data-testid="child-tab"
                class:list={[
                  'flex items-center gap-2 px-4 py-3 rounded-xl min-h-[56px] min-w-[120px] transition-colors',
                  sibling.id === childId
                    ? 'bg-primary text-primary-content font-bold'
                    : 'bg-base-200 hover:bg-base-300',
                ]}
              >
                <ColoredInitials name={sibling.name} color={sibling.color} size="sm" />
                <span class="text-lg">{sibling.name}</span>
              </a>
            ))}
          </nav>
        )}

        {/* Child header */}
        <header class="flex items-center gap-4 mb-8">
          <ColoredInitials name={child.name} color={child.color} size="lg" />
          <h1 class="text-3xl md:text-4xl font-bold">{child.name}</h1>
        </header>

        {/* Task list or celebration */}
        {tasks.length === 0 ? (
          <div data-testid="celebration" class="text-center py-16">
            <div data-testid="celebration-emoji" class="text-8xl mb-6">üåü</div>
            <h2 class="text-3xl md:text-4xl font-bold text-success mb-4">Super gemacht!</h2>
            <p class="text-xl md:text-2xl text-base-content/70">
              Alle Aufgaben erledigt!
            </p>
          </div>
        ) : (
          /* Simple list */
          <ul class="space-y-3" id="task-list">
            {tasks.map((task) => (
              <li
                data-testid="task-item"
                data-task-id={task.id}
                class="task-item flex items-center gap-4 p-4 bg-base-200 rounded-xl min-h-[56px]"
                style="transform: translateX(0); opacity: 1; transition: transform 400ms ease-out, opacity 300ms ease-out;"
              >
                <form method="POST" action={`/api/groups/${groupId}/tasks/${task.id}/complete`} class="complete-form">
                  <input type="hidden" name="childId" value={childId} />
                  <button
                    type="submit"
                    data-testid="complete-button"
                    class="btn btn-circle btn-lg btn-outline btn-success min-w-[56px] min-h-[56px]"
                    aria-label={`${task.title} erledigen`}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                  </button>
                </form>
                <span class="text-xl md:text-2xl flex-1">{task.title}</span>
              </li>
            ))}
          </ul>
        )}

        <div class="mt-8 pt-8 border-t border-base-300 flex justify-between items-center">
          <a href={`/group/${groupId}/tasks`} class="btn btn-ghost btn-sm">
            ‚Üê Zur√ºck zur √úbersicht
          </a>
          <DevSchedulerButton />
        </div>
      </div>
    )}

    {!child && !error && (
      <div class="text-center py-16">
        <p class="text-2xl text-gray-500">Kind nicht gefunden.</p>
      </div>
    )}
  </div>

  <script>
    // Task completion animation script
    // Handles form submission with slide-out animation before navigating
    document.addEventListener('DOMContentLoaded', () => {
      const forms = document.querySelectorAll<HTMLFormElement>('.complete-form')

      forms.forEach((form) => {
        form.addEventListener('submit', (e) => {
          const taskItem = form.closest('.task-item') as HTMLElement | null
          if (!taskItem) return // Fallback: let form submit normally

          e.preventDefault()

          // Start slide-out animation
          taskItem.style.transform = 'translateX(100%)'
          taskItem.style.opacity = '0'

          // After animation completes, submit the form
          setTimeout(() => {
            form.submit()
          }, 400) // Match transition duration
        })
      })
    })
  </script>
</Layout>
